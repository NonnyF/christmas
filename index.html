<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Tarot üéÑ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-red: #ff4d4d;
            --pixel-dark-red: #b30000;
            --pixel-green: #2ecc71;
            --pixel-yellow: #f1c40f;
            --bg-festive: #1a472a;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg-festive);
            color: white;
            image-rendering: pixelated;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
        }

        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        .thai-text { font-family: 'Sarabun', sans-serif; }

        .pixel-card {
            background-color: #fdfdfd;
            color: #333;
            border: 6px solid;
            border-image: repeating-linear-gradient(45deg, var(--pixel-red), var(--pixel-red) 10px, white 10px, white 20px) 10;
            box-shadow: 8px 8px 0px 0px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 500px;
            padding: 20px 10px;
            text-align: center;
            position: relative;
        }

        .tarot-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .tarot-card {
            width: 100%;
            aspect-ratio: 2/3;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .tarot-card.flipped { transform: rotateY(180deg); }
        .tarot-card.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .card-back {
            background-color: var(--pixel-red);
            background-image: radial-gradient(circle, white 15%, transparent 15%);
            background-size: 10px 10px;
        }

        .card-front { transform: rotateY(180deg); background: #fffbe6; }

        .pixel-btn {
            background-color: var(--pixel-red);
            color: white;
            padding: 12px;
            font-size: 8px;
            border: none;
            box-shadow: inset -3px -3px 0px 0px var(--pixel-dark-red);
            cursor: pointer;
        }

        #fortune-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: white;
            border: 6px solid var(--pixel-red);
            z-index: 100;
            display: none;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.8);
        }

        #overlay-blocker {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--pixel-red);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="fortune-modal">
        <div id="capture-area" class="p-5 bg-white">
            <div class="text-3xl mb-2">üéÅ</div>
            <h2 class="text-[8px] text-red-600 thai-text">CHRISTMAS DESTINY FOR:</h2>
            <h3 id="final-user-name" class="text-sm text-green-600 underline mb-4">NAME</h3>
            <div id="wish-history" class="space-y-2 mb-4"></div>
            <div class="p-3 border-4 border-double border-red-100 bg-red-50">
                <p id="gemini-summary" class="text-[10px] text-red-900 thai-text leading-relaxed font-bold"></p>
                <div id="gemini-loading" class="hidden">
                    <div class="loading-spinner"></div>
                    <p class="text-[6px] text-gray-500">GEMINI IS CONSULTING THE STARS...</p>
                </div>
            </div>
        </div>
        <div class="p-3 bg-gray-100 flex flex-col gap-2">
            <button onclick="downloadResults()" class="pixel-btn" style="background: #3498db; box-shadow: inset -3px -3px 0px #2980b9;">DOWNLOAD HD IMAGE</button>
            <button onclick="location.reload()" class="pixel-btn">PLAY AGAIN</button>
        </div>
    </div>

    <main class="pixel-card">
        <div id="overlay-blocker">
            <h2 class="text-[10px] text-red-600 mb-4">WHO ARE YOU?</h2>
            <input type="text" id="name-input" class="border-4 p-2 mb-4 text-center text-[10px]" placeholder="YOUR NAME...">
            <button onclick="startReading()" class="pixel-btn" style="background:var(--pixel-green); box-shadow: inset -3px -3px 0px #27ae60;">BEGIN</button>
        </div>

        <h1 class="text-xs text-red-500 mb-4">CHRISTMAS TAROT</h1>
        <div class="tarot-grid" id="tarot-deck"></div>
        <div class="bg-white p-3 min-h-[80px] border-4 border-red-50">
            <p id="reading-text" class="text-[9px] text-gray-400 thai-text">Draw 3 cards to see your fate...</p>
        </div>
    </main>

    <script>
        const apiKey = "AIzaSyDmEKLMDuFRKzfJwUcmIiOJD-PPhqtq87M"; // Leave blank for environment
        const wishTable = [
            { icon: 'üç™', name: 'The Baker', msg: "Sweetness follows you." },
            { icon: 'ü¶å', name: 'The Guide', msg: "You will lead others." },
            { icon: 'üéÑ', name: 'The Tree', msg: "Stability and growth." },
            { icon: 'üéÅ', name: 'The Gift', msg: "Unexpected fortune." },
            { icon: '‚ùÑÔ∏è', name: 'The Frost', msg: "Clarity through peace." },
            { icon: 'üß£', name: 'The Scarf', msg: "Protection and warmth." },
            { icon: 'üîî', name: 'The Chime', msg: "Fame and recognition." },
            { icon: 'üåü', name: 'The Star', msg: "Wishes coming true." },
            { icon: 'üçó', name: 'The Feast', msg: "Abundance and joy." },
            { icon: 'üïØÔ∏è', name: 'The Candle', msg: "New inspirations." }
        ];

        let drawnCount = 0;
        let selectedUser = "";
        let grantedWishes = [];
        let deckPool = [...wishTable].sort(() => Math.random() - 0.5);

        function startReading() {
            const name = document.getElementById('name-input').value.trim();
            if (!name) return;
            selectedUser = name;
            document.getElementById('overlay-blocker').style.display = 'none';
        }

        const deck = document.getElementById('tarot-deck');
        for (let i = 0; i < 8; i++) {
            const card = document.createElement('div');
            card.className = 'tarot-card';
            card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front" id="f-${i}"></div>`;
            card.onclick = () => {
                if (drawnCount < 3 && !card.classList.contains('flipped')) {
                    const res = deckPool[i];
                    grantedWishes.push(res);
                    document.getElementById(`f-${i}`).innerHTML = `<span class="text-xl">${res.icon}</span>`;
                    card.classList.add('flipped');
                    document.getElementById('reading-text').innerText = res.msg;
                    drawnCount++;
                    if (drawnCount === 3) {
                        document.querySelectorAll('.tarot-card').forEach(c => !c.classList.contains('flipped') && c.classList.add('disabled'));
                        setTimeout(showFortuneSummary, 1000);
                    }
                }
            };
            deck.appendChild(card);
        }

        async function showFortuneSummary() {
            document.getElementById('final-user-name').innerText = selectedUser.toUpperCase();
            document.getElementById('wish-history').innerHTML = grantedWishes.map(w => `<div class="text-[10px] text-left border-b pb-1"> ${w.icon} <b>${w.name}</b>: ${w.msg}</div>`).join('');
            document.getElementById('fortune-modal').style.display = 'block';
            
            await getGeminiSummary();
        }

        async function getGeminiSummary() {
            const loading = document.getElementById('gemini-loading');
            const resultBox = document.getElementById('gemini-summary');
            loading.classList.remove('hidden');

            const prompt = `Summarize a Christmas Tarot reading for ${selectedUser}. Cards drawn: ${grantedWishes.map(w => w.name).join(', ')}. Write a short, warm, and festive 2-sentence destiny in Thai language that connects these three themes. Start with "‡∏™‡∏£‡∏∏‡∏õ‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                resultBox.innerText = data.candidates[0].content.parts[0].text;
            } catch (error) {
                resultBox.innerText = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á!";
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function downloadResults() {
            const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2 });
            const link = document.createElement('a');
            link.download = `ChristmasDestiny_${selectedUser}.jpg`;
            link.href = canvas.toDataURL("image/jpeg");
            link.click();
        }
    </script>
</body>
</html>

